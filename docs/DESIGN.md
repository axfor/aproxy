# MySQL 到 PostgreSQL 代理 - 设计文档

## 概述

本文档描述了一个 MySQL 协议代理的架构和设计,该代理将 MySQL 客户端请求转换为 PostgreSQL 后端调用,使 MySQL 客户端能够透明地访问 PostgreSQL 数据库而无需修改代码。

## 架构

### 高层组件

```
┌─────────────────┐
│  MySQL 客户端    │
│  (任意驱动)      │
└────────┬────────┘
         │ MySQL 协议
         ▼
┌─────────────────────────────────────────┐
│         MySQL-PG 代理                    │
│  ┌─────────────────────────────────┐   │
│  │  MySQL 协议处理器                │   │
│  │  - 握手与认证                    │   │
│  │  - 包解析/序列化                 │   │
│  └──────────┬──────────────────────┘   │
│             │                            │
│  ┌──────────▼──────────────────────┐   │
│  │  会话管理器                       │   │
│  │  - 会话变量                      │   │
│  │  - 预编译语句                    │   │
│  │  - 事务状态                      │   │
│  │  - last_insert_id 跟踪          │   │
│  └──────────┬──────────────────────┘   │
│             │                            │
│  ┌──────────▼──────────────────────┐   │
│  │  SQL 重写引擎                     │   │
│  │  - 基于 AST 的转换               │   │
│  │  - 占位符转换                    │   │
│  │  - 函数映射                      │   │
│  │  - DDL 翻译                      │   │
│  └──────────┬──────────────────────┘   │
│             │                            │
│  ┌──────────▼──────────────────────┐   │
│  │  协议映射器                       │   │
│  │  - COM_* 命令映射                │   │
│  │  - 类型转换                      │   │
│  │  - 结果集转换                    │   │
│  └──────────┬──────────────────────┘   │
│             │                            │
│  ┌──────────▼──────────────────────┐   │
│  │  PostgreSQL 连接池               │   │
│  │  - 会话亲和性                    │   │
│  │  - 连接池化                      │   │
│  │  - 重连处理                      │   │
│  └──────────┬──────────────────────┘   │
│             │                            │
│  ┌──────────▼──────────────────────┐   │
│  │  安全与可观测性                   │   │
│  │  - 限流                          │   │
│  │  - 指标 (Prometheus)             │   │
│  │  - 结构化日志                    │   │
│  │  - 追踪 (OpenTelemetry)          │   │
│  └─────────────────────────────────┘   │
└─────────────┬───────────────────────────┘
              │ PostgreSQL 协议
              ▼
     ┌─────────────────┐
     │   PostgreSQL    │
     │      数据库      │
     └─────────────────┘
```

## 组件详情

### 1. MySQL 协议处理器

**职责:**
- 接受 MySQL 客户端连接
- 执行 MySQL 握手(支持 CLIENT_PROTOCOL_41, CLIENT_SSL, CLIENT_PLUGIN_AUTH 等)
- 处理认证(caching_sha2_password, mysql_native_password)
- 解析和序列化 MySQL 协议包
- 支持 TLS 连接

**关键接口:**
```go
type MySQLHandler interface {
    AcceptConnection(conn net.Conn) (*Session, error)
    Handshake(conn net.Conn) error
    Authenticate(conn net.Conn, credentials Credentials) error
    ReadPacket(conn net.Conn) (*Packet, error)
    WritePacket(conn net.Conn, packet *Packet) error
}
```

### 2. 会话管理器

**职责:**
- 维护每个客户端的会话状态
- 跟踪会话变量(@@ 和 @ 变量)
- 管理预编译语句映射(MySQL stmt_id → PG 预编译名称)
- 跟踪每个会话的 last_insert_id
- 管理事务状态和自动提交模式
- 处理临时表映射

**会话状态:**
```go
type Session struct {
    ID              string
    User            string
    Database        string
    Charset         string
    Autocommit      bool
    InTransaction   bool
    LastInsertID    uint64

    // 会话变量
    SessionVars     map[string]interface{}
    UserVars        map[string]interface{}

    // 预编译语句
    PreparedStmts   map[uint32]*PreparedStatement

    // PostgreSQL 连接(会话亲和性)
    PGConn          *pgx.Conn
}
```

### 3. SQL 重写引擎

**职责:**
- 使用 TiDB parser (pingcap/parser) 解析 MySQL SQL
- 将 AST 转换为 PostgreSQL 兼容的 SQL
- 处理语法差异
- 转换占位符(? → $1, $2, ...)
- 重写 DDL 语句
- 将 MySQL 函数映射到 PostgreSQL 等效函数

**关键转换:**

| MySQL | PostgreSQL | 说明 |
|-------|-----------|------|
| `?` 占位符 | `$1, $2, ...` | 基于位置的转换 |
| ``` `identifier` ``` | `"identifier"` | 引号风格 |
| `AUTO_INCREMENT` | `GENERATED BY DEFAULT AS IDENTITY` | 自增列 |
| `INSERT ... ON DUPLICATE KEY UPDATE` | `INSERT ... ON CONFLICT ... DO UPDATE` | Upsert 语法 |
| `REPLACE INTO` | `INSERT ... ON CONFLICT ... DO UPDATE` | 替换语义 |
| `NOW()` | `CURRENT_TIMESTAMP` | 函数映射 |
| `GROUP_CONCAT(x)` | `string_agg(x, ',')` | 聚合函数 |
| `LIMIT n, m` | `LIMIT m OFFSET n` | 分页 |
| `UNSIGNED` 类型 | CHECK 约束或 domain | 类型约束 |
| `TINYINT(1)` | `BOOLEAN` | 布尔映射 |
| `ENUM('a','b')` | `TEXT CHECK(...)` 或自定义类型 | 枚举处理 |

**接口:**
```go
type SQLRewriter interface {
    Rewrite(sql string) (string, error)
    RewritePrepared(sql string) (rewritten string, paramCount int, error error)
    ConvertPlaceholders(sql string) string
}
```

### 4. 协议映射器

**职责:**
- 将 MySQL 命令映射到 PostgreSQL 操作
- 处理 COM_QUERY, COM_PREPARE, COM_STMT_EXECUTE, COM_STMT_CLOSE
- MySQL 和 PostgreSQL 数据类型之间的转换
- 转换结果集
- 映射错误代码
- 处理特殊命令(SHOW, DESCRIBE 等)

**命令映射:**

| MySQL 命令 | PostgreSQL 操作 |
|-----------|----------------|
| COM_QUERY | Simple Query 或 Parse/Bind/Execute |
| COM_PREPARE | Parse + Describe Statement |
| COM_STMT_EXECUTE | Bind + Execute |
| COM_STMT_CLOSE | Deallocate Prepared Statement |
| COM_FIELD_LIST | 查询 information_schema |
| COM_PING | SELECT 1 |
| COM_QUIT | 关闭连接 |

### 5. 类型映射

MySQL 和 PostgreSQL 类型之间的完整映射:

| MySQL 类型 | PostgreSQL 类型 | 转换说明 |
|-----------|----------------|---------|
| TINYINT(1) | BOOLEAN | 布尔标志检测 |
| TINYINT | SMALLINT | 8位整数 |
| SMALLINT | SMALLINT | 16位整数 |
| MEDIUMINT | INTEGER | 24位 → 32位 |
| INT/INTEGER | INTEGER | 32位整数 |
| BIGINT | BIGINT | 64位整数 |
| FLOAT | REAL | 单精度 |
| DOUBLE | DOUBLE PRECISION | 双精度 |
| DECIMAL(p,s) | NUMERIC(p,s) | 精确数值 |
| CHAR(n) | CHAR(n) | 定长 |
| VARCHAR(n) | VARCHAR(n) | 变长 |
| TEXT | TEXT | 文本数据 |
| TINYTEXT | TEXT | 小文本 |
| MEDIUMTEXT | TEXT | 中文本 |
| LONGTEXT | TEXT | 大文本 |
| BLOB | BYTEA | 二进制数据 |
| TINYBLOB | BYTEA | 小二进制 |
| MEDIUMBLOB | BYTEA | 中二进制 |
| LONGBLOB | BYTEA | 大二进制 |
| DATE | DATE | 仅日期 |
| DATETIME | TIMESTAMP | 日期和时间 |
| TIMESTAMP | TIMESTAMP | 时间戳 |
| TIME | TIME | 仅时间 |
| YEAR | SMALLINT | 年份值 |
| JSON | JSONB | JSON 数据(推荐 JSONB) |
| ENUM | TEXT + CHECK 或 ENUM | 枚举 |
| SET | TEXT[] | 值集合 |
| BIT(n) | BIT(n) 或 BOOLEAN | 位字段 |

### 6. PostgreSQL 连接池

**职责:**
- 管理 PostgreSQL 连接
- 实现会话亲和性(1:1 MySQL 会话到 PG 连接)
- 处理连接失败和重连
- 支持无状态查询的连接池化
- 事务会话的事务固定

**策略:**
- **会话亲和模式(默认)**: 每个 MySQL 会话获得专用的 PG 连接
- **池化模式**: 连接被池化但在事务期间固定
- **混合模式**: 无状态查询使用池,事务使用亲和性

### 7. SHOW/DESCRIBE 命令模拟

必须通过查询 PostgreSQL 目录来模拟 MySQL 元数据命令:

**SHOW TABLES:**
```sql
SELECT table_name
FROM information_schema.tables
WHERE table_schema = current_schema()
```

**SHOW DATABASES:**
```sql
SELECT schema_name
FROM information_schema.schemata
```

**SHOW COLUMNS FROM table / DESCRIBE table:**
```sql
SELECT
    column_name AS Field,
    data_type AS Type,
    is_nullable AS Null,
    column_default AS Default,
    '' AS Key,
    '' AS Extra
FROM information_schema.columns
WHERE table_name = ?
```

**SET 命令:**
- `SET NAMES` → `SET client_encoding`
- `SET autocommit` → 在会话中跟踪,根据需要发送 BEGIN/COMMIT
- `SET @@session.var` → 在会话状态中跟踪
- `SET @user_var` → 存储在会话用户变量中

### 8. 错误映射

将 PostgreSQL SQLSTATE 代码映射到 MySQL 错误代码:

| PostgreSQL SQLSTATE | MySQL 错误代码 | 描述 |
|--------------------|--------------|------|
| 23505 | 1062 (ER_DUP_ENTRY) | 重复键 |
| 23503 | 1452 (ER_NO_REFERENCED_ROW_2) | 外键冲突 |
| 42501 | 1142 (ER_TABLEACCESS_DENIED_ERROR) | 访问被拒绝 |
| 42P01 | 1146 (ER_NO_SUCH_TABLE) | 表不存在 |
| 42703 | 1054 (ER_BAD_FIELD_ERROR) | 未知列 |
| 42601 | 1064 (ER_PARSE_ERROR) | 语法错误 |
| 40P01 | 1213 (ER_LOCK_DEADLOCK) | 死锁 |
| 57014 | 1317 (ER_QUERY_INTERRUPTED) | 查询中断 |

### 9. 安全层

**功能:**
- 最大包大小强制(默认 16MB)
- 每 IP/用户/全局限流
- 每 IP/用户连接限制
- 查询超时强制
- 危险命令黑名单
- SQL 审计日志与参数脱敏
- TLS 强制选项

**拒绝的命令:**
- COM_BINLOG_DUMP (复制)
- CHANGE MASTER TO
- FLUSH PRIVILEGES
- LOAD DATA LOCAL INFILE (可选,可配置)

### 10. 可观测性

**指标 (Prometheus):**
- `mysql_pg_proxy_active_connections` - 活跃 MySQL 连接
- `mysql_pg_proxy_total_queries` - 处理的总查询数
- `mysql_pg_proxy_query_duration_seconds` - 查询延迟直方图
- `mysql_pg_proxy_errors_total` - 按类型的错误计数
- `mysql_pg_proxy_pg_pool_size` - PostgreSQL 池指标
- `mysql_pg_proxy_bytes_in/out` - 网络流量

**日志:**
- 结构化 JSON 日志
- 字段: session_id, user, client_ip, query(可脱敏), duration, rows_affected, error
- 可配置日志级别

**追踪:**
- OpenTelemetry 集成
- 追踪 MySQL 请求 → SQL 重写 → PG 执行 → 响应

## 配置

```yaml
server:
  host: "0.0.0.0"
  port: 3306
  max_connections: 1000
  max_packet_size: 16777216  # 16MB
  read_timeout: 30s
  write_timeout: 30s

postgres:
  host: "localhost"
  port: 5432
  database: "mydb"
  user: "proxy_user"
  password: "secret"
  max_pool_size: 100
  connection_mode: "session_affinity"  # 或 "pooled" 或 "hybrid"

auth:
  mode: "pass_through"  # 或 "proxy_auth"
  allowed_users: ["user1", "user2"]

security:
  rate_limit_per_second: 1000
  max_connections_per_ip: 10
  enable_tls: true
  tls_cert: "/path/to/cert.pem"
  tls_key: "/path/to/key.pem"
  dangerous_commands_blacklist: ["COM_BINLOG_DUMP", "FLUSH PRIVILEGES"]

sql_rewrite:
  enabled: true
  custom_rules: "/path/to/rules.yaml"

observability:
  metrics_port: 9090
  log_level: "info"
  log_format: "json"
  enable_query_log: false
  redact_parameters: true
  enable_tracing: false
  tracing_endpoint: "localhost:4318"
```

## 已知限制

### 无法支持(基本差异)

1. **存储引擎特定功能:**
   - MyISAM 特定行为
   - InnoDB 特定的事务隔离细节
   - 存储引擎选择 (ENGINE=...)

2. **复制:**
   - 二进制日志操作
   - GTID
   - 主从命令

3. **MySQL 特有:**
   - MySQL 特定的存储过程/函数语法
   - MySQL 事件
   - MySQL 特定的触发器语法
   - 分区语法差异

### 部分支持(有变通方法)

1. **函数:**
   - 大多数可以映射,但某些边缘情况不同
   - 日期/时间函数行为可能不同
   - 字符串排序规则差异

2. **事务隔离:**
   - 引擎间的隔离级别语义不同
   - 需明确记录差异

3. **锁行为:**
   - `LOCK TABLES` → 咨询锁(尽力而为)
   - 行锁定语法不同

### 需要迁移

1. **存储过程:** 需重写为 PL/pgSQL
2. **触发器:** 需重写为 PostgreSQL 语法
3. **全文搜索:** 语法和功能不同
4. **AUTO_INCREMENT 序列:** 迁移到 SERIAL/IDENTITY

## 测试策略

### 单元测试
- 协议包解析/序列化
- SQL 重写规则
- 类型转换
- 错误映射
- 会话状态管理

### 集成测试
- 使用真实 MySQL 客户端的端到端测试(CLI, 驱动)
- 多驱动兼容性(mysql CLI, Node.js mysql2, Python mysql-connector, Go mysql driver, JDBC)
- 事务隔离测试
- 并发连接测试
- 预编译语句生命周期
- 二进制协议测试

### 安全测试
- 畸形包处理
- DOS 保护
- 限流有效性
- 认证绕过尝试
- 通过协议的 SQL 注入

### 性能测试
- 吞吐量基准测试(QPS)
- 延迟测量(P50, P95, P99)
- 连接池效率
- 负载下的内存使用

## 部署

### Docker
```dockerfile
FROM golang:1.21-alpine AS builder
WORKDIR /app
COPY . .
RUN GOEXPERIMENT=greenteagc go build -o aproxy ./cmd/aproxy

FROM alpine:latest
COPY --from=builder /app/aproxy /usr/local/bin/
EXPOSE 3306 9090
CMD ["aproxy"]
```

### Kubernetes
- StatefulSet 用于会话亲和性
- 带 LoadBalancer 的 Service
- 配置的 ConfigMap
- 凭证的 Secrets
- 扩展的 HPA
- PodDisruptionBudget

## 性能目标

- **吞吐量:** 每实例 10,000+ QPS
- **延迟:** P99 < 50ms (不包括网络)
- **连接:** 支持 1,000+ 并发连接
- **内存:** < 100MB 基础 + 每连接约 1MB
- **CPU:** < 50% @ 5,000 QPS (4核)

## 参考资料

- MySQL 协议: https://dev.mysql.com/doc/internals/en/client-server-protocol.html
- PostgreSQL 协议: https://www.postgresql.org/docs/current/protocol.html
- TiDB Parser: https://github.com/pingcap/parser
- go-mysql: https://github.com/go-mysql-org/go-mysql
- pgx: https://github.com/jackc/pgx
